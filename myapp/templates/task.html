<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Public Complaints & Requests</title>
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

:root {
  --primary-blue: #2563eb;
  --dark-blue: #1e40af;
  --light-blue: #dbeafe;
  --sidebar-bg: #1e3a8a;
  --sidebar-hover:#3b82f6;
  --text-dark: #1f2937;
  --text-light: #6b7280;
  --border-color: #e5e7eb;
  --success-green: #10b981;
  --danger-red: #ef4444;
  --warning-yellow: #fbbf24;
}

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background-color: #f8fafc;
  color: var(--text-dark);
}

/* Sidebar */
.sidebar {
  position: fixed;
  left: 0;
  top: 0;
  width: 260px;
  height: 100vh;
  background-color: var(--sidebar-bg);
  color: white;
  padding: 20px 0;
  z-index: 1000;
  box-shadow: 2px 0 10px rgba(0,0,0,0.1);
  overflow-y: auto;
}

.sidebar h2 {
  padding: 0 20px 20px;
  border-bottom: 1px solid rgba(255,255,255,0.1);
  margin-bottom: 20px;
  font-size: 1.5em;
  color: white;
  text-align: center;
  letter-spacing: 1px;
}

.menu {
  list-style: none;
}

.menu a {
  display: flex;
  align-items: center;
  padding: 14px 20px;
  color: #cbd5e1;
  text-decoration: none;
  transition: all 0.3s;
  font-size: 0.95em;
}

.menu a:hover,
.menu a.active {
  background-color: var(--sidebar-hover);
  color: white;
  border-left: 4px solid var(--primary-blue);
}

/* Main Content */
.main-content {
  margin-left: 260px;
  padding: 30px;
}

.page-header {
  background: white;
  padding: 25px 30px;
  border-radius: 12px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  margin-bottom: 30px;
}

.page-header h1 {
  font-size: 1.8em;
  color: var(--text-dark);
  margin-bottom: 5px;
}

.page-header p {
  color: var(--text-light);
  font-size: 0.95em;
}

/* Filter Section */
.filter-section {
  background: white;
  padding: 25px 30px;
  border-radius: 12px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  margin-bottom: 25px;
}

.filter-section h3 {
  font-size: 1.1em;
  color: var(--text-dark);
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.filter-container {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
}

.filter-group {
  display: flex;
  flex-direction: column;
}

.filter-group label {
  font-weight: 600;
  margin-bottom: 8px;
  color: var(--text-dark);
  font-size: 0.9em;
}

.filter-group select,
.filter-group input {
  padding: 10px 14px;
  border-radius: 8px;
  border: 1px solid var(--border-color);
  font-size: 0.95em;
  transition: all 0.3s;
  font-family: inherit;
}

.filter-group select:focus,
.filter-group input:focus {
  outline: none;
  border-color: var(--primary-blue);
  box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
}

/* Tasks Container */
.tasks-container {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.task-card {
  background: white;
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  display: grid;
  grid-template-columns: auto 1fr auto;
  gap: 20px;
  align-items: center;
  transition: all 0.3s;
  border-left: 4px solid transparent;
}

.task-card:hover {
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  transform: translateY(-2px);
}

.task-card[data-status="unverified"] {
  border-left-color: var(--danger-red);
}

.task-card[data-status="verified"] {
  border-left-color: var(--success-green);
}

.task-card[data-status="pending"] {
  border-left-color: var(--warning-yellow);
}

.task-card[data-status="complete"] {
  border-left-color: var(--primary-blue);
}

.profile-img {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--primary-blue), var(--dark-blue));
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 1.5em;
  font-weight: bold;
  flex-shrink: 0;
}

.task-details {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.task-details p {
  margin: 0;
  font-size: 0.9em;
  color: var(--text-light);
  line-height: 1.5;
}

.task-details strong {
  color: var(--text-dark);
  font-weight: 600;
  margin-right: 5px;
}

.task-type-badge {
  display: inline-block;
  padding: 4px 12px;
  border-radius: 12px;
  font-size: 0.75em;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-left: 10px;
}

.task-type-badge.complaint {
  background-color: #fee2e2;
  color: #991b1b;
}

.task-type-badge.request {
  background-color: #dbeafe;
  color: #1e40af;
}

.task-buttons {
  display: flex;
  flex-direction: column;
  gap: 8px;
  min-width: 130px;
}

.status-btn {
  padding: 8px 16px;
  font-size: 0.85em;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

/* Status Button Colors */
.unverified {
  background: #fee2e2;
  color: #991b1b;
}

.unverified:not(:disabled):hover {
  background: var(--danger-red);
  color: white;
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(239, 68, 68, 0.3);
}

.verified {
  background: #d1fae5;
  color: #065f46;
}

.pending {
  background: #fef3c7;
  color: #92400e;
}

.pending.active {
  background: var(--warning-yellow);
  color: #78350f;
}

.pending.active:not(:disabled):hover {
  background: #f59e0b;
  color: white;
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(251, 191, 36, 0.3);
}

.complete {
  background: #dbeafe;
  color: #1e40af;
}

.complete.active {
  background: var(--primary-blue);
  color: white;
}

.complete.active:not(:disabled):hover {
  background: var(--dark-blue);
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(37, 99, 235, 0.3);
}

.status-btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

/* Toast Message */
#toast {
  visibility: hidden;
  min-width: 250px;
  background: var(--success-green);
  color: white;
  text-align: center;
  border-radius: 8px;
  padding: 16px 20px;
  position: fixed;
  z-index: 2000;
  left: 50%;
  bottom: 30px;
  font-size: 0.95em;
  font-weight: 600;
  transform: translateX(-50%);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

#toast.show {
  visibility: visible;
  animation: slideUp 0.4s, slideDown 0.4s 2.6s;
}

@keyframes slideUp {
  from {
    bottom: 0;
    opacity: 0;
  }
  to {
    bottom: 30px;
    opacity: 1;
  }
}

@keyframes slideDown {
  from {
    bottom: 30px;
    opacity: 1;
  }
  to {
    bottom: 0;
    opacity: 0;
  }
}

/* Empty State */
.empty-state {
  background: white;
  border-radius: 12px;
  padding: 60px 20px;
  text-align: center;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.empty-state-icon {
  font-size: 4em;
  opacity: 0.3;
  margin-bottom: 20px;
}

.empty-state h3 {
  color: var(--text-dark);
  margin-bottom: 10px;
  font-size: 1.3em;
}

.empty-state p {
  color: var(--text-light);
  font-size: 0.95em;
}

/* Responsive */
@media (max-width: 768px) {
  .sidebar {
    width: 70px;
  }

  .sidebar h2 {
    font-size: 1.2em;
    writing-mode: vertical-rl;
  }

  .main-content {
    margin-left: 70px;
    padding: 20px;
  }

  .task-card {
    grid-template-columns: 1fr;
    gap: 15px;
  }

  .filter-container {
    grid-template-columns: 1fr;
  }

  .task-buttons {
    flex-direction: row;
    width: 100%;
  }

  .status-btn {
    flex: 1;
  }
}
</style>
</head>
<body>

<!-- Sidebar -->
<div class="sidebar" role="navigation" aria-label="Main sidebar">
  <h2>PANCHAYAT</h2>
  <div class="menu">
    <a href="{% url 'Mainpageadmin' %}">üè† Dashboard</a>
    <a href="{% url 'Posts' %}">üìå Posts</a>
    <a href="{% url 'Add_supervisor' %}">üë®‚Äçüíº Add Supervisor</a>
    <a href="{% url 'Add_eo' %}">üßë‚Äçüíº Add EO</a>
    <a href="{% url 'Tasks' %}" class="active">üóÇÔ∏è Tasks</a>
    <a href="{% url 'achievment' %}">üèÜ Achievements</a>
    <a href="{% url 'Add_area' %}">üìç Add Area</a>
  </div>
</div>

<!-- Main Content -->
<div class="main-content">
  
  <!-- Page Header -->
  <div class="page-header">
    <h1>Public Complaints & Requests</h1>
    <p>Manage and track all complaints and requests from the public</p>
  </div>

  <!-- Filters -->
  <div class="filter-section">
    <h3>üîç Filter Tasks</h3>
    <div class="filter-container">
      <div class="filter-group">
        <label for="type-filter">Type</label>
        <select id="type-filter">
          <option value="">All Types</option>
          <option value="complaint">Complaint</option>
          <option value="request">Request</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="supervisor-filter">Supervisor</label>
        <input list="supervisor-list" id="supervisor-filter" placeholder="Type supervisor name">
        <datalist id="supervisor-list">
          {% for s in supervisors %}
            <option value="{{ s.supervisor_name }}">{{s.supervisor_name}}</option>
          {% endfor %}
        </datalist>
      </div>
      <div class="filter-group">
        <label for="area-filter">Area</label>
        <input list="area-list" id="area-filter" placeholder="Type or select area">
        <datalist id="area-list">
          {% for a in areas %}
            <option value="{{ a.name }}">{{a.name}}</option>
          {% endfor %}
        </datalist>
      </div>
      <div class="filter-group">
        <label for="status-filter">Status</label>
        <select id="status-filter">
          <option value="">All Status</option>
          <option value="unverified">Unverified</option>
          <option value="verified">Verified</option>
          <option value="pending">Pending</option>
          <option value="complete">Complete</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Task Cards -->
  <div class="tasks-container" id="tasks-container">
    {% for item in complaints %}
    <div class="task-card" 
         data-id="{{ item.id }}" 
         data-type="complaint" 
         data-supervisor="{{ item.supervisor_name }}" 
         data-area="{{ item.location }}" 
         data-status="{{ item.status|default:'unverified' }}">
      <div class="profile-img">üë§</div>
      <div class="task-details">
        <p><strong>Name:</strong> {{ item.user }} <span class="task-type-badge complaint">Complaint</span></p>
        <p><strong>Phone:</strong> {{ item.phone }}</p>
        <p><strong>Address:</strong> {{ item.address }}</p>
        <p><strong>Area:</strong> {{ item.location }}</p>
        <p><strong>Complaint:</strong> {{ item.description }}</p>
        <p><strong>Supervisor:</strong> {{ item.supervisor_name }}</p>
      </div>
      <div class="task-buttons">
        <button class="status-btn unverified">Unverified</button>
        <button class="status-btn pending">Pending</button>
        <button class="status-btn complete">Complete</button>
      </div>
    </div>
    {% endfor %}

    {% for item in requests %}
    <div class="task-card" 
         data-id="{{ item.id }}" 
         data-type="request" 
         data-supervisor="{{ item.supervisor_name }}" 
         data-area="{{ item.area }}" 
         data-status="{{ item.status|default:'unverified' }}">
      <div class="profile-img">üë§</div>
      <div class="task-details">
        <p><strong>Name:</strong> {{ item.name }} <span class="task-type-badge request">Request</span></p>
        <p><strong>Phone:</strong> {{ item.phone_number }}</p>
        <p><strong>Address:</strong> {{ item.address }}</p>
        <p><strong>Area:</strong> {{ item.area }}</p>
        <p><strong>Request:</strong> {{ item.request_type }}</p>
        <p><strong>Supervisor:</strong> {{ item.supervisor_name }}</p>
      </div>
      <div class="task-buttons">
        <button class="status-btn unverified">Unverified</button>
        <button class="status-btn pending">Pending</button>
        <button class="status-btn complete">Complete</button>
      </div>
    </div>
    {% endfor %}

    {% if not complaints and not requests %}
    <div class="empty-state">
      <div class="empty-state-icon">üìã</div>
      <h3>No Tasks Found</h3>
      <p>There are no complaints or requests to display at the moment.</p>
    </div>
    {% endif %}
  </div>
</div>

<!-- Toast -->
<div id="toast">Process Complete!</div>

<script>
// CSRF helper
function getCookie(name){
  let cookieValue = null;
  if(document.cookie && document.cookie!==''){
    const cookies = document.cookie.split(';');
    for(let cookie of cookies){
      cookie = cookie.trim();
      if(cookie.startsWith(name+'=')){
        cookieValue = decodeURIComponent(cookie.slice(name.length+1));
        break;
      }
    }
  }
  return cookieValue;
}
const csrftoken = getCookie('csrftoken');

// Toast function
function showToast(msg){
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.className = "show";
  setTimeout(()=>{ toast.className = toast.className.replace("show",""); },3000);
}

// Update button states based on workflow
function updateButtons(card){
  const status = card.dataset.status.toLowerCase();
  const unv = card.querySelector('.unverified');
  const pen = card.querySelector('.pending');
  const comp = card.querySelector('.complete');

  // Reset
  [unv, pen, comp].forEach(b=>{
    b.disabled = true;
    b.classList.remove('active');
  });

  if(status==='unverified'){
    unv.disabled=false;
    unv.classList.add('unverified');
  } else if(status==='verified'){
    unv.classList.add('verified');
    pen.disabled=false;
    pen.classList.add('active'); // dark yellow
  } else if(status==='pending'){
    unv.classList.add('verified');
    pen.classList.add('active');
    comp.disabled=false;
    comp.classList.add('active'); // dark blue
  } else if(status==='complete'){
    unv.classList.add('verified');
    pen.classList.add('active');
    comp.classList.add('active');
  }
}

// Initialize buttons
document.querySelectorAll('.task-card').forEach(card=>{
  updateButtons(card);

  card.querySelectorAll('.status-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
        const id = card.dataset.id;
        const type = card.dataset.type;  // "complaint" or "request"
        const clicked = btn.textContent.toLowerCase();

        let url = '';
        if(type==='complaint'){
            url = `/toggle-status/${id}/`;
        } else if(type==='request'){
            url = `/toggle-request-status/${id}/`;
        }

        fetch(url, {
            method:'POST',
            headers:{'Content-Type':'application/json','X-CSRFToken': csrftoken},
            body: JSON.stringify({status: clicked})
        })
        .then(res=>res.json())
        .then(data=>{
            if(data.success){
                card.dataset.status = clicked;
                updateButtons(card);
                if(clicked==='complete'){
                    showToast('Process Complete!');
                }
            } else {
                alert('Failed to update status: '+data.error);
            }
        });
    });
});
});

// Filters
const typeFilter = document.getElementById('type-filter');
const supervisorFilter = document.getElementById('supervisor-filter');
const areaFilter = document.getElementById('area-filter');
const statusFilter = document.getElementById('status-filter');
const taskCards = document.querySelectorAll('.task-card');

function filterCards(){
  const typeVal = typeFilter.value.toLowerCase();
  const supervisorVal = supervisorFilter.value.toLowerCase();
  const areaVal = areaFilter.value.toLowerCase();
  const statusVal = statusFilter.value.toLowerCase();

  taskCards.forEach(card=>{
    const matchType = !typeVal || card.dataset.type===typeVal;
    const matchSupervisor = !supervisorVal || card.dataset.supervisor.toLowerCase().includes(supervisorVal);
    const matchArea = !areaVal || card.dataset.area.toLowerCase().includes(areaVal);
    const matchStatus = !statusVal || card.dataset.status.toLowerCase()===statusVal;

    card.style.display = (matchType && matchSupervisor && matchArea && matchStatus)?'grid':'none';
  });
}

[typeFilter, supervisorFilter, areaFilter, statusFilter].forEach(f=>f.addEventListener('input', filterCards));
</script>
</body>
</html>